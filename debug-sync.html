<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•ä½™é¢åŒæ­¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ” è°ƒè¯•ä½™é¢åŒæ­¥</h1>

        <!-- Token ä¿¡æ¯ -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”‘ Token ä¿¡æ¯</h2>
            <div id="tokenInfo" class="text-sm font-mono"></div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="bg-red-50 border border-red-200 rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ› æ•°æ®åº“è°ƒè¯•ä¿¡æ¯</h2>
            <button onclick="debugDatabase()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 font-semibold">
                ğŸ” æŸ¥çœ‹æ•°æ®åº“è¯¦ç»†ä¿¡æ¯
            </button>
            <div id="debugInfo" class="mt-4"></div>
        </div>

        <!-- æ­¥éª¤ 1: è·å–ç›‘æ§åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ­¥éª¤ 1: è·å–ç›‘æ§åˆ—è¡¨</h2>
            <button onclick="getMonitors()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                ğŸ“‹ è·å–ç›‘æ§åˆ—è¡¨
            </button>
            <div id="monitorList" class="mt-4"></div>
        </div>
        
        <!-- æ­¥éª¤ 2: åŒæ­¥ä½™é¢ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ­¥éª¤ 2: åŒæ­¥ä½™é¢</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">é€‰æ‹©ç›‘æ§ ID:</label>
                <input type="number" id="monitorId" class="border rounded px-3 py-2 w-32" placeholder="ID">
                <button onclick="syncBalance()" class="ml-2 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold">
                    ğŸ”„ åŒæ­¥ä½™é¢
                </button>
            </div>
            <div id="syncResult" class="mt-4"></div>
        </div>
        
        <!-- æ­¥éª¤ 3: æŸ¥çœ‹æ•°æ®åº“æ•°æ® -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">æ­¥éª¤ 3: æŸ¥çœ‹æ›´æ–°åçš„æ•°æ®</h2>
            <button onclick="getMonitors()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                ğŸ”„ é‡æ–°è·å–ç›‘æ§åˆ—è¡¨
            </button>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://43.163.239.222';

        // è§£æ JWT Token
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // æ˜¾ç¤º Token ä¿¡æ¯
        function showTokenInfo() {
            const token = localStorage.getItem('token');
            const div = document.getElementById('tokenInfo');

            if (!token) {
                div.innerHTML = '<p class="text-red-600">âŒ æœªæ‰¾åˆ° Token</p>';
                return;
            }

            const decoded = parseJwt(token);
            if (!decoded) {
                div.innerHTML = '<p class="text-red-600">âŒ Token è§£æå¤±è´¥</p>';
                return;
            }

            const now = Math.floor(Date.now() / 1000);
            const isExpired = decoded.exp && decoded.exp < now;

            div.innerHTML = `
                <div class="bg-white p-4 rounded border">
                    <div class="grid grid-cols-2 gap-2">
                        <div><strong>ç”¨æˆ· ID:</strong></div>
                        <div class="text-blue-600 font-bold">${decoded.userId || 'N/A'}</div>

                        <div><strong>ç”¨æˆ·å:</strong></div>
                        <div>${decoded.username || 'N/A'}</div>

                        <div><strong>Token çŠ¶æ€:</strong></div>
                        <div class="${isExpired ? 'text-red-600' : 'text-green-600'} font-bold">
                            ${isExpired ? 'âŒ å·²è¿‡æœŸ' : 'âœ… æœ‰æ•ˆ'}
                        </div>

                        ${decoded.exp ? `
                            <div><strong>è¿‡æœŸæ—¶é—´:</strong></div>
                            <div>${new Date(decoded.exp * 1000).toLocaleString('zh-CN')}</div>
                        ` : ''}
                    </div>

                    <details class="mt-3">
                        <summary class="cursor-pointer text-blue-600 hover:text-blue-800">æŸ¥çœ‹å®Œæ•´ Token æ•°æ®</summary>
                        <pre class="mt-2 text-xs overflow-auto bg-gray-800 text-green-400 p-3 rounded">${JSON.stringify(decoded, null, 2)}</pre>
                    </details>
                </div>
            `;
        }

        async function getMonitors() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('âŒ æœªæ‰¾åˆ° Tokenï¼Œè¯·å…ˆç™»å½•');
                return;
            }

            const div = document.getElementById('monitorList');
            div.innerHTML = '<p class="text-blue-600">â³ æ­£åœ¨åŠ è½½...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/monitor?action=list`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('ç›‘æ§åˆ—è¡¨å“åº”:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '<div class="space-y-4">';
                    
                    data.data.forEach(monitor => {
                        const mainnetAvailable = parseFloat(monitor.mainnet_available || 0);
                        const mainnetLocked = parseFloat(monitor.mainnet_locked || 0);
                        const mainnetTotal = parseFloat(monitor.mainnet_total || 0);
                        const testnetAvailable = parseFloat(monitor.testnet_available || 0);
                        const testnetLocked = parseFloat(monitor.testnet_locked || 0);
                        const testnetTotal = parseFloat(monitor.testnet_total || 0);
                        const totalBalance = mainnetTotal + testnetTotal;
                        
                        html += `
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-lg">${monitor.name || 'æœªå‘½å'}</h3>
                                        <p class="text-sm text-gray-600 font-mono">${monitor.wallet_address}</p>
                                    </div>
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                                        ID: ${monitor.id}
                                    </span>
                                </div>
                                
                                <div class="bg-white p-4 rounded border mb-3">
                                    <h4 class="font-semibold mb-2">ğŸ“Š æ•°æ®åº“ä¸­çš„åŸå§‹æ•°æ®:</h4>
                                    <div class="grid grid-cols-2 gap-2 text-sm font-mono">
                                        <div class="col-span-2 bg-purple-50 p-2 rounded">
                                            <strong>æ€»ä½™é¢:</strong> ${totalBalance.toFixed(8)} Ï€
                                        </div>
                                        <div class="bg-blue-50 p-2 rounded">
                                            <strong>ä¸»ç½‘å¯ç”¨:</strong> ${mainnetAvailable.toFixed(8)} Ï€
                                        </div>
                                        <div class="bg-blue-50 p-2 rounded">
                                            <strong>ä¸»ç½‘é”å®š:</strong> ${mainnetLocked.toFixed(8)} Ï€
                                        </div>
                                        <div class="bg-blue-50 p-2 rounded">
                                            <strong>ä¸»ç½‘æ€»è®¡:</strong> ${mainnetTotal.toFixed(8)} Ï€
                                        </div>
                                        <div class="bg-green-50 p-2 rounded">
                                            <strong>æµ‹è¯•ç½‘å¯ç”¨:</strong> ${testnetAvailable.toFixed(8)} Ï€
                                        </div>
                                        <div class="bg-green-50 p-2 rounded">
                                            <strong>æµ‹è¯•ç½‘é”å®š:</strong> ${testnetLocked.toFixed(8)} Ï€
                                        </div>
                                        <div class="bg-green-50 p-2 rounded">
                                            <strong>æµ‹è¯•ç½‘æ€»è®¡:</strong> ${testnetTotal.toFixed(8)} Ï€
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="document.getElementById('monitorId').value = ${monitor.id}; syncBalance();" 
                                    class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold">
                                    ğŸ”„ åŒæ­¥æ­¤ç›‘æ§ (ID: ${monitor.id})
                                </button>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    div.innerHTML = html;
                } else {
                    div.innerHTML = '<p class="text-yellow-600">ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ç›‘æ§</p>';
                }
                
            } catch (error) {
                console.error('è·å–ç›‘æ§åˆ—è¡¨å¤±è´¥:', error);
                div.innerHTML = `<p class="text-red-600">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }
        
        async function syncBalance() {
            const monitorId = document.getElementById('monitorId').value;
            if (!monitorId) {
                alert('è¯·è¾“å…¥ç›‘æ§ ID');
                return;
            }
            
            const token = localStorage.getItem('token');
            const div = document.getElementById('syncResult');
            div.innerHTML = '<p class="text-blue-600">â³ æ­£åœ¨åŒæ­¥...</p>';
            
            try {
                const url = `${API_BASE_URL}/api/monitor-sync?action=sync-one&id=${monitorId}`;
                console.log('åŒæ­¥ URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('åŒæ­¥å“åº”:', data);
                
                let html = `
                    <div class="border rounded-lg p-4 ${data.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                        <h3 class="font-bold mb-3 ${data.success ? 'text-green-800' : 'text-red-800'}">
                            ${data.success ? 'âœ… åŒæ­¥æˆåŠŸ' : 'âŒ åŒæ­¥å¤±è´¥'}
                        </h3>
                `;
                
                if (data.success && data.data) {
                    const d = data.data;
                    html += `
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded border">
                                <h4 class="font-semibold mb-2">ğŸ“Š API è¿”å›çš„æ•°æ®:</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm font-mono">
                                    <div><strong>é’±åŒ…åœ°å€:</strong></div>
                                    <div class="break-all">${d.wallet_address || 'N/A'}</div>
                                    
                                    <div><strong>æ—§ä½™é¢:</strong></div>
                                    <div>${d.old_balance || 0} Ï€</div>
                                    
                                    <div><strong>æ–°ä½™é¢:</strong></div>
                                    <div>${d.new_balance || 0} Ï€</div>
                                    
                                    <div><strong>å˜åŒ–:</strong></div>
                                    <div class="${d.balance_change >= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${d.balance_change >= 0 ? '+' : ''}${d.balance_change || 0} Ï€
                                    </div>
                                    
                                    <div class="col-span-2 bg-blue-50 p-2 rounded mt-2">
                                        <strong>ğŸŒ ä¸»ç½‘æ•°æ®:</strong>
                                    </div>
                                    <div>å¯ç”¨ä½™é¢:</div>
                                    <div>${d.mainnet_available || 0} Ï€</div>
                                    <div>é”å®šä½™é¢:</div>
                                    <div>${d.mainnet_locked || 0} Ï€</div>
                                    <div>æ€»ä½™é¢:</div>
                                    <div>${d.mainnet_total || 0} Ï€</div>
                                    
                                    <div class="col-span-2 bg-green-50 p-2 rounded mt-2">
                                        <strong>ğŸ§ª æµ‹è¯•ç½‘æ•°æ®:</strong>
                                    </div>
                                    <div>å¯ç”¨ä½™é¢:</div>
                                    <div>${d.testnet_available || 0} Ï€</div>
                                    <div>é”å®šä½™é¢:</div>
                                    <div>${d.testnet_locked || 0} Ï€</div>
                                    <div>æ€»ä½™é¢:</div>
                                    <div>${d.testnet_total || 0} Ï€</div>
                                    
                                    <div class="col-span-2 bg-purple-50 p-2 rounded mt-2">
                                        <strong>æ€»ä½™é¢ (ä¸»ç½‘ + æµ‹è¯•ç½‘):</strong>
                                        ${(parseFloat(d.mainnet_total || 0) + parseFloat(d.testnet_total || 0)).toFixed(2)} Ï€
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-100 p-3 rounded">
                                <h4 class="font-semibold mb-2">ğŸ” å®Œæ•´ JSON å“åº”:</h4>
                                <pre class="text-xs overflow-auto bg-gray-800 text-green-400 p-3 rounded">${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                } else {
                    html += `<p class="text-red-600">é”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }
                
                html += `
                        <button onclick="getMonitors()" class="mt-4 w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 font-semibold">
                            ğŸ”„ æŸ¥çœ‹æ›´æ–°åçš„æ•°æ®åº“æ•°æ®
                        </button>
                    </div>
                `;
                
                div.innerHTML = html;
                
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                div.innerHTML = `<p class="text-red-600">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }
        
        // è°ƒè¯•æ•°æ®åº“
        async function debugDatabase() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('âŒ æœªæ‰¾åˆ° Tokenï¼Œè¯·å…ˆç™»å½•');
                return;
            }

            const div = document.getElementById('debugInfo');
            div.innerHTML = '<p class="text-blue-600">â³ æ­£åœ¨æŸ¥è¯¢æ•°æ®åº“...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/debug-monitors`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('è°ƒè¯•ä¿¡æ¯:', data);

                if (data.success && data.debug_info) {
                    const info = data.debug_info;
                    let html = '<div class="space-y-4">';

                    // Token ä¿¡æ¯
                    html += `
                        <div class="bg-white p-4 rounded border">
                            <h4 class="font-semibold mb-2">ğŸ”‘ Token è§£æç»“æœ:</h4>
                            <div class="text-sm font-mono">
                                <div>ç”¨æˆ· ID: <span class="text-blue-600 font-bold">${info.token_decoded.userId}</span></div>
                                <div>ç”¨æˆ·å: ${info.token_decoded.username}</div>
                                <div>è¿‡æœŸæ—¶é—´: ${info.token_decoded.exp || 'N/A'}</div>
                            </div>
                        </div>
                    `;

                    // ç”¨æˆ·ä¿¡æ¯
                    html += `
                        <div class="bg-white p-4 rounded border">
                            <h4 class="font-semibold mb-2">ğŸ‘¤ æ•°æ®åº“ä¸­çš„ç”¨æˆ·ä¿¡æ¯:</h4>
                            ${info.user_in_database ? `
                                <div class="text-sm font-mono">
                                    <div>ID: ${info.user_in_database.id}</div>
                                    <div>ç”¨æˆ·å: ${info.user_in_database.username}</div>
                                    <div>é‚®ç®±: ${info.user_in_database.email || 'N/A'}</div>
                                </div>
                            ` : '<p class="text-red-600">âŒ ç”¨æˆ·ä¸å­˜åœ¨</p>'}
                        </div>
                    `;

                    // æ‰€æœ‰ç›‘æ§
                    html += `
                        <div class="bg-white p-4 rounded border">
                            <h4 class="font-semibold mb-2">ğŸ“Š æ•°æ®åº“ä¸­çš„æ‰€æœ‰ç›‘æ§ (å…± ${info.all_monitors_count} ä¸ª):</h4>
                            ${info.all_monitors.length > 0 ? `
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-xs">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="px-2 py-1 text-left">ID</th>
                                                <th class="px-2 py-1 text-left">User ID</th>
                                                <th class="px-2 py-1 text-left">åç§°</th>
                                                <th class="px-2 py-1 text-left">é’±åŒ…åœ°å€</th>
                                                <th class="px-2 py-1 text-left">çŠ¶æ€</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${info.all_monitors.map(m => `
                                                <tr class="${m.user_id === info.token_decoded.userId ? 'bg-green-50' : ''}">
                                                    <td class="px-2 py-1">${m.id}</td>
                                                    <td class="px-2 py-1 font-bold ${m.user_id === info.token_decoded.userId ? 'text-green-600' : 'text-gray-600'}">${m.user_id}</td>
                                                    <td class="px-2 py-1">${m.monitor_name || 'N/A'}</td>
                                                    <td class="px-2 py-1 font-mono text-xs">${m.wallet_address.substring(0, 10)}...</td>
                                                    <td class="px-2 py-1">${m.status}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-gray-600">æ²¡æœ‰ç›‘æ§</p>'}
                        </div>
                    `;

                    // å½“å‰ç”¨æˆ·çš„ç›‘æ§
                    html += `
                        <div class="bg-white p-4 rounded border">
                            <h4 class="font-semibold mb-2">âœ… å½“å‰ç”¨æˆ·çš„ç›‘æ§ (å…± ${info.user_monitors_count} ä¸ª):</h4>
                            ${info.user_monitors.length > 0 ? `
                                <pre class="text-xs overflow-auto bg-gray-800 text-green-400 p-3 rounded">${JSON.stringify(info.user_monitors, null, 2)}</pre>
                            ` : '<p class="text-red-600 font-bold">âŒ å½“å‰ç”¨æˆ·æ²¡æœ‰ç›‘æ§ï¼è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ï¼</p>'}
                        </div>
                    `;

                    html += '</div>';
                    div.innerHTML = html;
                } else {
                    div.innerHTML = `<p class="text-red-600">âŒ é”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }

            } catch (error) {
                console.error('è°ƒè¯•å¤±è´¥:', error);
                div.innerHTML = `<p class="text-red-600">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–ç›‘æ§åˆ—è¡¨
        window.onload = function() {
            showTokenInfo();
            debugDatabase();
            getMonitors();
        };
    </script>
</body>
</html>

