<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç®€å•æµ‹è¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        pre { background: #000; padding: 15px; border: 1px solid #0f0; overflow: auto; }
        .section { margin: 20px 0; padding: 15px; border: 2px solid #0f0; }
        h2 { color: #0ff; }
    </style>
</head>
<body>
    <h1>ğŸ” API æµ‹è¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>1. è·å–ç›‘æ§åˆ—è¡¨</h2>
        <button onclick="testGetMonitors()">ğŸ“‹ è·å–ç›‘æ§åˆ—è¡¨</button>
        <pre id="monitors-result">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹ç»“æœ...</pre>
    </div>
    
    <div class="section">
        <h2>2. åŒæ­¥ä½™é¢</h2>
        <input type="number" id="sync-id" placeholder="ç›‘æ§ ID" value="6" style="padding: 8px; font-size: 16px;">
        <button onclick="testSync()">ğŸ”„ åŒæ­¥ä½™é¢ (V2 API)</button>
        <button onclick="testSyncOld()">ğŸ”„ åŒæ­¥ä½™é¢ (æ—§ API)</button>
        <pre id="sync-result">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹ç»“æœ...</pre>
    </div>
    
    <div class="section">
        <h2>3. æ•°æ®åº“è°ƒè¯•</h2>
        <button onclick="testDebug()">ğŸ› æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯</button>
        <pre id="debug-result">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹ç»“æœ...</pre>
    </div>

    <script>
        const API_BASE_URL = 'http://43.163.239.222';
        
        function getToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('âŒ æœªæ‰¾åˆ° Tokenï¼è¯·å…ˆç™»å½•ã€‚');
                return null;
            }
            return token;
        }
        
        async function testGetMonitors() {
            const token = getToken();
            if (!token) return;
            
            const resultDiv = document.getElementById('monitors-result');
            resultDiv.textContent = 'â³ æ­£åœ¨è¯·æ±‚...';
            
            try {
                const url = `${API_BASE_URL}/api/monitor?action=list`;
                console.log('è¯·æ±‚ URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);
                
                resultDiv.textContent = JSON.stringify(data, null, 2);
                
                // å¦‚æœæˆåŠŸï¼Œæ˜¾ç¤ºç›‘æ§æ•°é‡
                if (data.success && data.data) {
                    alert(`âœ… æˆåŠŸè·å– ${data.data.length} ä¸ªç›‘æ§`);
                }
            } catch (error) {
                console.error('é”™è¯¯:', error);
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}\n\n${error.stack}`;
            }
        }
        
        async function testSync() {
            const token = getToken();
            if (!token) return;

            const monitorId = document.getElementById('sync-id').value;
            if (!monitorId) {
                alert('è¯·è¾“å…¥ç›‘æ§ ID');
                return;
            }

            const resultDiv = document.getElementById('sync-result');
            resultDiv.textContent = 'â³ æ­£åœ¨åŒæ­¥...';

            try {
                const url = `${API_BASE_URL}/api/monitor-sync-v2?id=${monitorId}`;
                console.log('è¯·æ±‚ URL (V2):', url);
                console.log('Token:', token);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”å¤´:', [...response.headers.entries()]);

                const responseText = await response.text();
                console.log('åŸå§‹å“åº”:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('JSON è§£æå¤±è´¥:', e);
                    resultDiv.textContent = `âŒ å“åº”ä¸æ˜¯æœ‰æ•ˆçš„ JSON:\n\n${responseText}`;
                    return;
                }

                console.log('å“åº”æ•°æ®:', data);

                resultDiv.textContent = JSON.stringify(data, null, 2);

                if (data.success) {
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«è¯¦ç»†å­—æ®µ
                    const hasDetails = data.data &&
                                      'mainnet_available' in data.data &&
                                      'testnet_available' in data.data;

                    if (hasDetails) {
                        alert(`âœ… åŒæ­¥æˆåŠŸï¼\n\n` +
                              `ä¸»ç½‘å¯ç”¨: ${data.data.mainnet_available} Ï€\n` +
                              `ä¸»ç½‘é”å®š: ${data.data.mainnet_locked} Ï€\n` +
                              `æµ‹è¯•ç½‘å¯ç”¨: ${data.data.testnet_available} Ï€\n` +
                              `æµ‹è¯•ç½‘é”å®š: ${data.data.testnet_locked} Ï€\n\n` +
                              `API ç‰ˆæœ¬: ${data.data.api_version || 'æœªçŸ¥'}`);

                        // åŒæ­¥æˆåŠŸåï¼Œé‡æ–°è·å–ç›‘æ§åˆ—è¡¨
                        setTimeout(() => {
                            testGetMonitors();
                        }, 1000);
                    } else {
                        alert('âš ï¸ åŒæ­¥æˆåŠŸï¼Œä½†è¿”å›æ•°æ®ç¼ºå°‘è¯¦ç»†å­—æ®µï¼\nè¯·æŸ¥çœ‹ä¸‹æ–¹çš„ JSON æ•°æ®ã€‚');
                    }
                } else {
                    alert(`âŒ åŒæ­¥å¤±è´¥: ${data.message || JSON.stringify(data)}`);
                }
            } catch (error) {
                console.error('é”™è¯¯:', error);
                alert(`âŒ è¯·æ±‚é”™è¯¯: ${error.message}`);
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}\n\n${error.stack}`;
            }
        }
        
        async function testSyncOld() {
            const token = getToken();
            if (!token) return;

            const monitorId = document.getElementById('sync-id').value;
            if (!monitorId) {
                alert('è¯·è¾“å…¥ç›‘æ§ ID');
                return;
            }

            const resultDiv = document.getElementById('sync-result');
            resultDiv.textContent = 'â³ æ­£åœ¨åŒæ­¥ï¼ˆæ—§ APIï¼‰...';

            try {
                const url = `${API_BASE_URL}/api/monitor-sync?action=sync-one&id=${monitorId}`;
                console.log('è¯·æ±‚ URL (æ—§ API):', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('æ—§ API å“åº”:', data);

                resultDiv.textContent = JSON.stringify(data, null, 2);

                if (data.success) {
                    alert(`âœ… æ—§ API åŒæ­¥æˆåŠŸï¼\n\nä½™é¢: ${data.data.new_balance} Ï€`);
                } else {
                    alert(`âŒ æ—§ API åŒæ­¥å¤±è´¥: ${data.message}`);
                }
            } catch (error) {
                console.error('é”™è¯¯:', error);
                alert(`âŒ è¯·æ±‚é”™è¯¯: ${error.message}`);
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
        }

        async function testDebug() {
            const token = getToken();
            if (!token) return;
            
            const resultDiv = document.getElementById('debug-result');
            resultDiv.textContent = 'â³ æ­£åœ¨æŸ¥è¯¢...';
            
            try {
                const url = `${API_BASE_URL}/api/debug-monitors`;
                console.log('è¯·æ±‚ URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);
                
                resultDiv.textContent = JSON.stringify(data, null, 2);
                
                if (data.success && data.debug_info) {
                    const info = data.debug_info;
                    alert(`âœ… è°ƒè¯•ä¿¡æ¯:\n\n` +
                          `ç”¨æˆ· ID: ${info.token_decoded.userId}\n` +
                          `ç”¨æˆ·å: ${info.token_decoded.username}\n` +
                          `æ‰€æœ‰ç›‘æ§æ•°: ${info.all_monitors_count}\n` +
                          `ç”¨æˆ·ç›‘æ§æ•°: ${info.user_monitors_count}`);
                }
            } catch (error) {
                console.error('é”™è¯¯:', error);
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}\n\n${error.stack}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            console.log('é¡µé¢å·²åŠ è½½');
            console.log('Token å­˜åœ¨:', !!localStorage.getItem('token'));
        };
    </script>
</body>
</html>

