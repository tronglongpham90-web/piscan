<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨èè¿”ç° - PiExplorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex">
        <!-- ä¾§è¾¹æ  -->
        <aside class="w-64 bg-white shadow-lg">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-purple-600">PiExplorer</h1>
                <p class="text-sm text-gray-500 mt-1">é’±åŒ…ç›‘æ§ç³»ç»Ÿ</p>
            </div>
            
            <nav class="mt-6">
                <a href="/monitor/dashboard.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">ğŸ“Š</span>
                    <span>ä»ªè¡¨æ¿</span>
                </a>
                <a href="/monitor/add-monitor.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">â•</span>
                    <span>æ·»åŠ ç›‘æ§</span>
                </a>
                <a href="/monitor/notifications.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">ğŸ””</span>
                    <span>é€šçŸ¥å†å²</span>
                </a>
                <a href="/monitor/referral.html" class="flex items-center px-6 py-3 bg-purple-50 text-purple-600 border-r-4 border-purple-600">
                    <span class="text-xl mr-3">ğŸ’°</span>
                    <span>æ¨èè¿”ç°</span>
                </a>
                <a href="/monitor/settings.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">âš™ï¸</span>
                    <span>è´¦æˆ·è®¾ç½®</span>
                </a>
                <a href="/monitor/social-tasks.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">ğŸ¯</span>
                    <span>ç¤¾äº¤ä»»åŠ¡</span>
                </a>
                <a href="/monitor/upgrade.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">â­</span>
                    <span>å‡çº§ä¼šå‘˜</span>
                </a>
            </nav>

            <div class="absolute bottom-0 w-64 p-6 border-t">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-900" id="user-email">ç”¨æˆ·</p>
                        <p class="text-xs text-gray-500">å…è´¹ç‰ˆ</p>
                    </div>
                    <button id="logout-btn" class="text-red-600 hover:text-red-700">
                        <span class="text-xl">ğŸšª</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="flex-1 p-8">
            <div class="max-w-6xl mx-auto">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">æ¨èè¿”ç°</h2>
                    <p class="text-gray-600 mt-2">é‚€è¯·å¥½å‹æ³¨å†Œï¼Œè·å¾—ä¸°åšå¥–åŠ±</p>
                </div>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <p class="text-sm opacity-90">æˆ‘çš„æ¨èç </p>
                        <p class="text-3xl font-bold mt-2" id="referral-code">åŠ è½½ä¸­...</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <p class="text-sm text-gray-500">å·²é‚€è¯·äººæ•°</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="total-referrals">0</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <p class="text-sm text-gray-500">ç´¯è®¡æ”¶ç›Š</p>
                        <p class="text-3xl font-bold text-green-600 mt-2" id="total-earnings">Â¥0</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <p class="text-sm text-gray-500">å¯æç°é‡‘é¢</p>
                        <p class="text-3xl font-bold text-blue-600 mt-2" id="available-balance">Â¥0</p>
                    </div>
                </div>

                <!-- æ¨èé“¾æ¥ -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">åˆ†äº«æ¨èé“¾æ¥</h3>
                    <div class="flex items-center space-x-4">
                        <input 
                            type="text" 
                            id="referral-link" 
                            readonly 
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
                            value="https://piexplorer.online/auth/register?ref=LOADING"
                        >
                        <button onclick="copyLink()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 whitespace-nowrap">
                            ğŸ“‹ å¤åˆ¶é“¾æ¥
                        </button>
                        <button onclick="shareToSocial()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap">
                            ğŸ“¤ åˆ†äº«
                        </button>
                    </div>
                    
                    <!-- å¥–åŠ±è¯´æ˜ -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-2xl mb-2">ğŸ</div>
                            <h4 class="font-semibold text-gray-900">æ³¨å†Œå¥–åŠ±</h4>
                            <p class="text-sm text-gray-600 mt-1">å¥½å‹æ³¨å†ŒæˆåŠŸï¼Œæ‚¨è·å¾— <span class="font-bold text-purple-600">Â¥5</span></p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-2xl mb-2">ğŸ’</div>
                            <h4 class="font-semibold text-gray-900">å‡çº§å¥–åŠ±</h4>
                            <p class="text-sm text-gray-600 mt-1">å¥½å‹å‡çº§ä¼šå‘˜ï¼Œæ‚¨è·å¾— <span class="font-bold text-blue-600">10%</span> è¿”ç°</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-2xl mb-2">ğŸ”„</div>
                            <h4 class="font-semibold text-gray-900">æŒç»­æ”¶ç›Š</h4>
                            <p class="text-sm text-gray-600 mt-1">å¥½å‹ç»­è´¹ä¼šå‘˜ï¼Œæ‚¨æŒç»­è·å¾— <span class="font-bold text-green-600">5%</span> è¿”ç°</p>
                        </div>
                    </div>
                </div>

                <!-- æ¨èè®°å½• -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">æ¨èè®°å½•</h3>
                        <button onclick="withdrawEarnings()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ğŸ’¸ ç”³è¯·æç°
                        </button>
                    </div>

                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div id="loading-state" class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                        <p class="mt-4 text-gray-600">åŠ è½½ä¸­...</p>
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="empty-state" class="hidden text-center py-12">
                        <span class="text-6xl">ğŸ‘¥</span>
                        <p class="mt-4 text-xl font-semibold text-gray-700">è¿˜æ²¡æœ‰æ¨èè®°å½•</p>
                        <p class="mt-2 text-gray-500">åˆ†äº«æ‚¨çš„æ¨èé“¾æ¥ï¼Œé‚€è¯·å¥½å‹åŠ å…¥</p>
                    </div>

                    <!-- æ¨èåˆ—è¡¨ -->
                    <div id="referral-list" class="hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç”¨æˆ·</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ³¨å†Œæ—¶é—´</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¼šå‘˜ç±»å‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ‚¨çš„æ”¶ç›Š</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="referral-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- åŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'https://piexplorer-api.vercel.app';
        const VERCEL_BYPASS_TOKEN = 'q9Ad6yNz2v787XKcQ1uE0Q8H0NxNddZW';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('token');
            const userEmail = localStorage.getItem('userEmail');
            
            if (!token || !userEmail) {
                window.location.href = '/auth/login.html';
                return false;
            }
            
            document.getElementById('user-email').textContent = userEmail;
            return true;
        }

        // é€€å‡ºç™»å½•
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            window.location.href = '/auth/login.html';
        });

        // åŠ è½½æ¨èæ•°æ®
        async function loadReferralData() {
            if (!checkAuth()) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/referral?action=stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const stats = data.data;
                    document.getElementById('referral-code').textContent = stats.referralCode;
                    document.getElementById('total-referrals').textContent = stats.totalReferrals;
                    document.getElementById('total-earnings').textContent = `Â¥${stats.totalEarnings.toFixed(2)}`;
                    document.getElementById('available-balance').textContent = `Â¥${stats.availableBalance.toFixed(2)}`;
                    
                    const link = `https://piexplorer.online/auth/register?ref=${stats.referralCode}`;
                    document.getElementById('referral-link').value = link;

                    if (stats.referrals && stats.referrals.length > 0) {
                        renderReferrals(stats.referrals);
                        document.getElementById('referral-list').classList.remove('hidden');
                    } else {
                        document.getElementById('empty-state').classList.remove('hidden');
                    }
                }

                document.getElementById('loading-state').classList.add('hidden');
            } catch (error) {
                console.error('åŠ è½½æ¨èæ•°æ®å¤±è´¥:', error);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            }
        }

        // æ¸²æŸ“æ¨èåˆ—è¡¨
        function renderReferrals(referrals) {
            const tbody = document.getElementById('referral-tbody');
            tbody.innerHTML = '';

            referrals.forEach(ref => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${ref.email}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${new Date(ref.registeredAt).toLocaleDateString('zh-CN')}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${getMembershipBadge(ref.membershipType)}">
                            ${getMembershipName(ref.membershipType)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm font-semibold text-green-600">
                        Â¥${ref.earnings.toFixed(2)}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${ref.paid ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${ref.paid ? 'å·²ç»“ç®—' : 'å¾…ç»“ç®—'}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // è·å–ä¼šå‘˜å¾½ç« æ ·å¼
        function getMembershipBadge(type) {
            const badges = {
                'free': 'bg-gray-100 text-gray-800',
                'social': 'bg-blue-100 text-blue-800',
                'paid': 'bg-purple-100 text-purple-800'
            };
            return badges[type] || 'bg-gray-100 text-gray-800';
        }

        // è·å–ä¼šå‘˜åç§°
        function getMembershipName(type) {
            const names = {
                'free': 'å…è´¹ç‰ˆ',
                'social': 'ç¤¾äº¤ä»»åŠ¡ç‰ˆ',
                'paid': 'ä»˜è´¹ç‰ˆ'
            };
            return names[type] || type;
        }

        // å¤åˆ¶é“¾æ¥
        function copyLink() {
            const input = document.getElementById('referral-link');
            input.select();
            document.execCommand('copy');
            alert('âœ… æ¨èé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }

        // åˆ†äº«åˆ°ç¤¾äº¤åª’ä½“
        function shareToSocial() {
            const link = document.getElementById('referral-link').value;
            const text = `åŠ å…¥ PiExplorerï¼Œç›‘æ§æ‚¨çš„ Pi é’±åŒ…ä½™é¢å˜åŒ–ï¼ä½¿ç”¨æˆ‘çš„æ¨èé“¾æ¥æ³¨å†Œï¼š${link}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'PiExplorer æ¨è',
                    text: text,
                    url: link
                });
            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«åŠŸèƒ½ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥åˆ†äº«');
            }
        }

        // ç”³è¯·æç°
        async function withdrawEarnings() {
            if (!confirm('ç¡®å®šè¦ç”³è¯·æç°å—ï¼Ÿ')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/referral?action=withdraw`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… æç°ç”³è¯·å·²æäº¤ï¼Œæˆ‘ä»¬ä¼šåœ¨3ä¸ªå·¥ä½œæ—¥å†…å¤„ç†');
                    loadReferralData();
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                console.error('æç°å¤±è´¥:', error);
                alert('âŒ æç°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            loadReferralData();
        });
    </script>
</body>
</html>

