<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦æˆ·è®¾ç½® - PiExplorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex">
        <!-- ä¾§è¾¹æ  -->
        <aside class="w-64 bg-white shadow-lg">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-purple-600">PiExplorer</h1>
                <p class="text-sm text-gray-500 mt-1">é’±åŒ…ç›‘æ§ç³»ç»Ÿ</p>
            </div>
            
            <nav class="mt-6">
                <a href="/monitor/dashboard.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">ğŸ“Š</span>
                    <span>ä»ªè¡¨æ¿</span>
                </a>
                <a href="/monitor/add-monitor.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">â•</span>
                    <span>æ·»åŠ ç›‘æ§</span>
                </a>
                <a href="/monitor/notifications.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">ğŸ””</span>
                    <span>é€šçŸ¥å†å²</span>
                </a>
                <!-- æ¨èè¿”ç°åŠŸèƒ½æš‚æ—¶éšè— -->
                <!-- <a href="/monitor/referral.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">ğŸ’°</span>
                    <span>æ¨èè¿”ç°</span>
                </a> -->
                <a href="/monitor/settings.html" class="flex items-center px-6 py-3 bg-purple-50 text-purple-600 border-r-4 border-purple-600">
                    <span class="text-xl mr-3">âš™ï¸</span>
                    <span>è´¦æˆ·è®¾ç½®</span>
                </a>
                <a href="/monitor/social-tasks.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">ğŸ¯</span>
                    <span>ç¤¾äº¤ä»»åŠ¡</span>
                </a>
                <a href="/monitor/upgrade.html" class="flex items-center px-6 py-3 text-gray-700 hover:bg-purple-50 hover:text-purple-600">
                    <span class="text-xl mr-3">â­</span>
                    <span>å‡çº§ä¼šå‘˜</span>
                </a>
            </nav>

            <div class="absolute bottom-0 w-64 p-6 border-t">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-900" id="user-email">ç”¨æˆ·</p>
                        <p class="text-xs text-gray-500">å…è´¹ç‰ˆ</p>
                    </div>
                    <button id="logout-btn" class="text-red-600 hover:text-red-700">
                        <span class="text-xl">ğŸšª</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="flex-1 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">è´¦æˆ·è®¾ç½®</h2>
                    <p class="text-gray-600 mt-2">ç®¡ç†æ‚¨çš„ä¸ªäººä¿¡æ¯å’Œåå¥½è®¾ç½®</p>
                </div>

                <!-- ä¸ªäººä¿¡æ¯ -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">ä¸ªäººä¿¡æ¯</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é‚®ç®±åœ°å€</label>
                            <input type="email" id="email" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" value="åŠ è½½ä¸­...">
                            <p class="text-xs text-gray-500 mt-1">é‚®ç®±åœ°å€ä¸å¯ä¿®æ”¹</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä¼šå‘˜ç±»å‹</label>
                            <div class="flex items-center space-x-2">
                                <span id="membership-badge" class="px-3 py-1 text-sm font-semibold rounded-full bg-gray-100 text-gray-800">å…è´¹ç‰ˆ</span>
                                <a href="/monitor/upgrade.html" class="text-purple-600 hover:text-purple-700 text-sm font-medium">å‡çº§ä¼šå‘˜ â†’</a>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ³¨å†Œæ—¶é—´</label>
                            <input type="text" id="created-at" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" value="åŠ è½½ä¸­...">
                        </div>
                    </div>
                </div>

                <!-- ä¿®æ”¹å¯†ç  -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">ä¿®æ”¹å¯†ç </h3>
                    
                    <form id="password-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å½“å‰å¯†ç </label>
                            <input type="password" id="current-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ–°å¯†ç </label>
                            <input type="password" id="new-password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <p class="text-xs text-gray-500 mt-1">å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" id="confirm-password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>

                        <button type="submit" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            æ›´æ–°å¯†ç 
                        </button>
                    </form>
                </div>

                <!-- é€šçŸ¥è®¾ç½® -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">é€šçŸ¥è®¾ç½®</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">é‚®ä»¶é€šçŸ¥</p>
                                <p class="text-sm text-gray-500">ä½™é¢å˜åŒ–æ—¶å‘é€é‚®ä»¶é€šçŸ¥</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="email-notifications" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">æµè§ˆå™¨é€šçŸ¥</p>
                                <p class="text-sm text-gray-500">åœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºé€šçŸ¥</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="browser-notifications" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">æ¯æ—¥æ‘˜è¦</p>
                                <p class="text-sm text-gray-500">æ¯å¤©å‘é€ç›‘æ§æ‘˜è¦é‚®ä»¶</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="daily-summary" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="saveNotificationSettings()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                ä¿å­˜é€šçŸ¥è®¾ç½®
                            </button>
                            <button onclick="sendTestEmail()" id="test-email-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <span>ğŸ“§</span>
                                <span>æµ‹è¯•é‚®ä»¶</span>
                            </button>
                        </div>

                        <!-- æµ‹è¯•é‚®ä»¶ç»“æœæç¤º -->
                        <div id="test-email-result" class="hidden mt-4 p-4 rounded-lg"></div>
                    </div>
                </div>

                <!-- å±é™©åŒºåŸŸ -->
                <div class="bg-white rounded-xl shadow-md p-6 border-2 border-red-200">
                    <h3 class="text-xl font-bold text-red-600 mb-6">å±é™©åŒºåŸŸ</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">åˆ é™¤æ‰€æœ‰ç›‘æ§</p>
                                <p class="text-sm text-gray-500">åˆ é™¤æ‚¨çš„æ‰€æœ‰é’±åŒ…ç›‘æ§è®°å½•</p>
                            </div>
                            <button onclick="deleteAllMonitors()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                åˆ é™¤ç›‘æ§
                            </button>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">åˆ é™¤è´¦æˆ·</p>
                                <p class="text-sm text-gray-500">æ°¸ä¹…åˆ é™¤æ‚¨çš„è´¦æˆ·å’Œæ‰€æœ‰æ•°æ®</p>
                            </div>
                            <button onclick="deleteAccount()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                åˆ é™¤è´¦æˆ·
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'https://piexplorer-api.vercel.app';
        const VERCEL_BYPASS_TOKEN = 'q9Ad6yNz2v787XKcQ1uE0Q8H0NxNddZW';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('token');
            const userEmail = localStorage.getItem('userEmail');
            
            if (!token || !userEmail) {
                window.location.href = '/auth/login.html';
                return false;
            }
            
            document.getElementById('user-email').textContent = userEmail;
            return true;
        }

        // é€€å‡ºç™»å½•
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            window.location.href = '/auth/login.html';
        });

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            if (!checkAuth()) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/user?action=profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const user = data.data;
                    document.getElementById('email').value = user.email;
                    document.getElementById('created-at').value = new Date(user.createdAt).toLocaleString('zh-CN');
                    
                    const membershipBadge = document.getElementById('membership-badge');
                    membershipBadge.textContent = getMembershipName(user.membershipType);
                    membershipBadge.className = `px-3 py-1 text-sm font-semibold rounded-full ${getMembershipBadge(user.membershipType)}`;

                    // åŠ è½½é€šçŸ¥è®¾ç½®
                    if (user.settings) {
                        document.getElementById('email-notifications').checked = user.settings.emailNotifications;
                        document.getElementById('browser-notifications').checked = user.settings.browserNotifications;
                        document.getElementById('daily-summary').checked = user.settings.dailySummary;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // è·å–ä¼šå‘˜å¾½ç« æ ·å¼
        function getMembershipBadge(type) {
            const badges = {
                'free': 'bg-gray-100 text-gray-800',
                'social': 'bg-blue-100 text-blue-800',
                'paid': 'bg-purple-100 text-purple-800'
            };
            return badges[type] || 'bg-gray-100 text-gray-800';
        }

        // è·å–ä¼šå‘˜åç§°
        function getMembershipName(type) {
            const names = {
                'free': 'å…è´¹ç‰ˆ',
                'social': 'ç¤¾äº¤ä»»åŠ¡ç‰ˆ',
                'paid': 'ä»˜è´¹ç‰ˆ'
            };
            return names[type] || type;
        }

        // ä¿®æ”¹å¯†ç 
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                alert('âŒ ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/user?action=change-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('token');
                    window.location.href = '/auth/login.html';
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                alert('âŒ ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        });

        // ä¿å­˜é€šçŸ¥è®¾ç½®
        async function saveNotificationSettings() {
            try {
                const token = localStorage.getItem('token');
                const settings = {
                    emailNotifications: document.getElementById('email-notifications').checked,
                    browserNotifications: document.getElementById('browser-notifications').checked,
                    dailySummary: document.getElementById('daily-summary').checked
                };

                const response = await fetch(`${API_BASE_URL}/api/user?action=settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… é€šçŸ¥è®¾ç½®å·²ä¿å­˜');
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                alert('âŒ ä¿å­˜è®¾ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // å‘é€æµ‹è¯•é‚®ä»¶
        async function sendTestEmail() {
            const btn = document.getElementById('test-email-btn');
            const resultDiv = document.getElementById('test-email-result');

            // ç¦ç”¨æŒ‰é’®
            btn.disabled = true;
            btn.innerHTML = '<span>â³</span><span>å‘é€ä¸­...</span>';

            // éšè—ä¹‹å‰çš„ç»“æœ
            resultDiv.classList.add('hidden');

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/send-test-email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    resultDiv.className = 'mt-4 p-4 rounded-lg bg-green-50 border-l-4 border-green-500';
                    resultDiv.innerHTML = `
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">âœ…</span>
                            <div>
                                <p class="font-bold text-green-800 mb-1">æµ‹è¯•é‚®ä»¶å·²å‘é€ï¼</p>
                                <p class="text-sm text-green-700">
                                    å·²å‘é€åˆ°: <strong>${data.email}</strong>
                                </p>
                                <p class="text-sm text-green-600 mt-2">
                                    è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹ï¼‰
                                </p>
                                ${data.simulated ? '<p class="text-xs text-yellow-600 mt-2">âš ï¸ æ³¨æ„ï¼šé‚®ä»¶æœåŠ¡æœªé…ç½®ï¼Œè¿™æ˜¯æ¨¡æ‹Ÿå“åº”</p>' : ''}
                            </div>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                } else {
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    resultDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 border-l-4 border-red-500';
                    resultDiv.innerHTML = `
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">âŒ</span>
                            <div>
                                <p class="font-bold text-red-800 mb-1">å‘é€å¤±è´¥</p>
                                <p class="text-sm text-red-700">${data.message}</p>
                            </div>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('å‘é€æµ‹è¯•é‚®ä»¶å¤±è´¥:', error);
                resultDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 border-l-4 border-red-500';
                resultDiv.innerHTML = `
                    <div class="flex items-start">
                        <span class="text-2xl mr-3">âŒ</span>
                        <div>
                            <p class="font-bold text-red-800 mb-1">å‘é€å¤±è´¥</p>
                            <p class="text-sm text-red-700">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>
                        </div>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            } finally {
                // æ¢å¤æŒ‰é’®
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ“§</span><span>æµ‹è¯•é‚®ä»¶</span>';
            }
        }

        // åˆ é™¤æ‰€æœ‰ç›‘æ§
        async function deleteAllMonitors() {
            if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ç›‘æ§å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            if (!confirm('âš ï¸ å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰ç›‘æ§å—ï¼Ÿ')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/monitor?action=delete-all`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… æ‰€æœ‰ç›‘æ§å·²åˆ é™¤');
                    window.location.href = '/monitor/dashboard.html';
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤ç›‘æ§å¤±è´¥:', error);
                alert('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åˆ é™¤è´¦æˆ·
        async function deleteAccount() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šåˆ é™¤è´¦æˆ·å°†æ°¸ä¹…åˆ é™¤æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ç›‘æ§è®°å½•ã€é€šçŸ¥å†å²ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            if (!confirm('âš ï¸ æœ€åç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤è´¦æˆ·å—ï¼Ÿ')) return;

            const password = prompt('è¯·è¾“å…¥æ‚¨çš„å¯†ç ä»¥ç¡®è®¤åˆ é™¤ï¼š');
            if (!password) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/user?action=delete-account`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… è´¦æˆ·å·²åˆ é™¤');
                    localStorage.clear();
                    window.location.href = '/';
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤è´¦æˆ·å¤±è´¥:', error);
                alert('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
        });
    </script>
</body>
</html>

