<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿å‘Šç®¡ç† - PiExplorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">ğŸ“º å¹¿å‘Šç®¡ç†</h1>

        <!-- å¹¿å‘Šä½åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">å¹¿å‘Šä½åˆ—è¡¨</h2>
            <div id="ads-list" class="space-y-4">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- æ·»åŠ æ–°å¹¿å‘Šä½ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æ·»åŠ æ–°å¹¿å‘Šä½</h2>
            <form id="add-ad-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¹¿å‘Šä½ID</label>
                        <input type="text" name="placement_id" required
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                               placeholder="ä¾‹å¦‚: dashboard_top">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¹¿å‘Šä½åç§°</label>
                        <input type="text" name="name" required
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                               placeholder="ä¾‹å¦‚: ä»ªè¡¨æ¿é¡¶éƒ¨æ¨ªå¹…">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¡µé¢</label>
                        <select name="page" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="dashboard">ä»ªè¡¨æ¿</option>
                            <option value="detail">ç›‘æ§è¯¦æƒ…</option>
                            <option value="notifications">é€šçŸ¥å†å²</option>
                            <option value="all">æ‰€æœ‰é¡µé¢</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½ç½®</label>
                        <select name="position" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="top">é¡¶éƒ¨</option>
                            <option value="sidebar">ä¾§è¾¹æ </option>
                            <option value="middle">ä¸­é—´</option>
                            <option value="bottom">åº•éƒ¨</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¹³å°</label>
                        <select name="platform"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="a-ads">A-ADS</option>
                            <option value="coinzilla">Coinzilla</option>
                            <option value="bitmedia">Bitmedia</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¼˜å…ˆçº§</label>
                        <input type="number" name="priority" value="0"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¹¿å‘Šä»£ç </label>
                    <textarea name="ad_code" required rows="5"
                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                              placeholder="ç²˜è´´å¹¿å‘Šä»£ç ..."></textarea>
                </div>

                <div class="flex items-center space-x-6">
                    <label class="flex items-center">
                        <input type="checkbox" name="show_for_free" checked class="mr-2">
                        <span class="text-sm text-gray-700">å…è´¹ç”¨æˆ·æ˜¾ç¤º</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="show_for_pro" class="mr-2">
                        <span class="text-sm text-gray-700">ä¸“ä¸šç‰ˆæ˜¾ç¤º</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="show_for_enterprise" class="mr-2">
                        <span class="text-sm text-gray-700">ä¼ä¸šç‰ˆæ˜¾ç¤º</span>
                    </label>
                </div>

                <button type="submit"
                        class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                    æ·»åŠ å¹¿å‘Šä½
                </button>
            </form>
        </div>

        <!-- å¹¿å‘Šç»Ÿè®¡ -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">å¹¿å‘Šç»Ÿè®¡ï¼ˆæœ€è¿‘30å¤©ï¼‰</h2>
            <div id="ads-stats" class="space-y-2">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://piexplorer-api.vercel.app';

        // åŠ è½½å¹¿å‘Šä½åˆ—è¡¨
        async function loadAdsList() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ads?action=list`);
                const data = await response.json();

                if (data.success && data.placements) {
                    const container = document.getElementById('ads-list');
                    container.innerHTML = data.placements.map(ad => `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800">${ad.name}</h3>
                                    <p class="text-sm text-gray-600">ID: ${ad.placement_id}</p>
                                    <p class="text-sm text-gray-600">é¡µé¢: ${ad.page} | ä½ç½®: ${ad.position}</p>
                                    <p class="text-sm text-gray-600">å¹³å°: ${ad.platform || 'a-ads'}</p>
                                    <div class="mt-2 flex items-center space-x-2">
                                        ${ad.show_for_free ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">å…è´¹</span>' : ''}
                                        ${ad.show_for_pro ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">ä¸“ä¸šç‰ˆ</span>' : ''}
                                        ${ad.show_for_enterprise ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">ä¼ä¸šç‰ˆ</span>' : ''}
                                        <span class="px-2 py-1 ${ad.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} text-xs rounded">
                                            ${ad.status === 'active' ? 'æ´»è·ƒ' : 'åœç”¨'}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="toggleAdStatus('${ad.placement_id}', '${ad.status}')"
                                            class="px-3 py-1 text-sm ${ad.status === 'active' ? 'bg-yellow-500' : 'bg-green-500'} text-white rounded hover:opacity-80">
                                        ${ad.status === 'active' ? 'åœç”¨' : 'å¯ç”¨'}
                                    </button>
                                    <button onclick="deleteAd('${ad.placement_id}')"
                                            class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                            <details class="mt-2">
                                <summary class="cursor-pointer text-sm text-gray-600">æŸ¥çœ‹å¹¿å‘Šä»£ç </summary>
                                <pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-x-auto">${ad.ad_code}</pre>
                            </details>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load ads list:', error);
            }
        }

        // æ·»åŠ å¹¿å‘Šä½
        document.getElementById('add-ad-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                placement_id: formData.get('placement_id'),
                name: formData.get('name'),
                page: formData.get('page'),
                position: formData.get('position'),
                ad_code: formData.get('ad_code'),
                platform: formData.get('platform'),
                priority: parseInt(formData.get('priority')),
                show_for_free: formData.get('show_for_free') === 'on',
                show_for_pro: formData.get('show_for_pro') === 'on',
                show_for_enterprise: formData.get('show_for_enterprise') === 'on'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/ads?action=create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('âœ… å¹¿å‘Šä½æ·»åŠ æˆåŠŸï¼');
                    e.target.reset();
                    loadAdsList();
                } else {
                    alert('âŒ æ·»åŠ å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âŒ æ·»åŠ å¤±è´¥: ' + error.message);
            }
        });

        // åˆ‡æ¢å¹¿å‘ŠçŠ¶æ€
        async function toggleAdStatus(placementId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/ads?action=update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ placement_id: placementId, status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    alert('âœ… çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                    loadAdsList();
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤å¹¿å‘Šä½
        async function deleteAd(placementId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¹¿å‘Šä½å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/ads?action=delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ placement_id: placementId })
                });

                const result = await response.json();

                if (result.success) {
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                    loadAdsList();
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½å¹¿å‘Šç»Ÿè®¡
        async function loadAdsStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ads?action=stats&days=30`);
                const data = await response.json();

                if (data.success && data.stats) {
                    const container = document.getElementById('ads-stats');
                    if (data.stats.length === 0) {
                        container.innerHTML = '<p class="text-gray-500">æš‚æ— ç»Ÿè®¡æ•°æ®</p>';
                    } else {
                        container.innerHTML = data.stats.map(stat => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="font-medium">${stat.placement_id}</span>
                                <div class="text-sm text-gray-600">
                                    å±•ç¤º: ${stat.impressions} | ç‹¬ç«‹ç”¨æˆ·: ${stat.unique_users} | æ´»è·ƒå¤©æ•°: ${stat.active_days}
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Failed to load ads stats:', error);
            }
        }

        // é¡µé¢åŠ è½½
        loadAdsList();
        loadAdsStats();
    </script>
</body>
</html>

