<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token è°ƒè¯• - PiExplorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold mb-6">ğŸ” Token è°ƒè¯•å·¥å…·</h1>
            
            <div class="space-y-4">
                <!-- Token çŠ¶æ€ -->
                <div class="border rounded p-4">
                    <h2 class="font-semibold mb-2">ğŸ“‹ LocalStorage çŠ¶æ€</h2>
                    <div id="storage-info" class="space-y-2 text-sm font-mono"></div>
                </div>

                <!-- Token è§£ç  -->
                <div class="border rounded p-4">
                    <h2 class="font-semibold mb-2">ğŸ”“ Token è§£ç </h2>
                    <div id="token-decode" class="space-y-2 text-sm"></div>
                </div>

                <!-- API æµ‹è¯• -->
                <div class="border rounded p-4">
                    <h2 class="font-semibold mb-2">ğŸ§ª API è¿æ¥æµ‹è¯•</h2>
                    <button onclick="testAPI()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        æµ‹è¯• API è¿æ¥
                    </button>
                    <div id="api-result" class="mt-4 text-sm"></div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="border rounded p-4">
                    <h2 class="font-semibold mb-2">ğŸ› ï¸ æ“ä½œ</h2>
                    <div class="space-x-2">
                        <button onclick="clearStorage()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            æ¸…é™¤æ‰€æœ‰æ•°æ®
                        </button>
                        <button onclick="location.href='/auth/login.html'" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            é‡æ–°ç™»å½•
                        </button>
                        <button onclick="location.reload()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            åˆ·æ–°é¡µé¢
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://43.163.239.222';

        // æ˜¾ç¤º localStorage ä¿¡æ¯
        function displayStorageInfo() {
            const storageDiv = document.getElementById('storage-info');
            const token = localStorage.getItem('token');
            const userEmail = localStorage.getItem('userEmail');
            const userId = localStorage.getItem('userId');
            const user = localStorage.getItem('user');

            let html = '';
            html += `<div><strong>Token:</strong> ${token ? 'âœ… å­˜åœ¨ (' + token.substring(0, 20) + '...)' : 'âŒ ä¸å­˜åœ¨'}</div>`;
            html += `<div><strong>User Email:</strong> ${userEmail || 'âŒ ä¸å­˜åœ¨'}</div>`;
            html += `<div><strong>User ID:</strong> ${userId || 'âŒ ä¸å­˜åœ¨'}</div>`;
            html += `<div><strong>User Object:</strong> ${user ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</div>`;

            storageDiv.innerHTML = html;
        }

        // è§£ç  JWT Token
        function decodeToken() {
            const decodeDiv = document.getElementById('token-decode');
            const token = localStorage.getItem('token');

            if (!token) {
                decodeDiv.innerHTML = '<div class="text-red-600">âŒ æ²¡æœ‰æ‰¾åˆ° Token</div>';
                return;
            }

            try {
                // JWT æ ¼å¼: header.payload.signature
                const parts = token.split('.');
                if (parts.length !== 3) {
                    decodeDiv.innerHTML = '<div class="text-red-600">âŒ Token æ ¼å¼é”™è¯¯</div>';
                    return;
                }

                // è§£ç  payload (Base64)
                const payload = JSON.parse(atob(parts[1]));
                
                // æ£€æŸ¥è¿‡æœŸæ—¶é—´
                const now = Math.floor(Date.now() / 1000);
                const isExpired = payload.exp && payload.exp < now;
                const expiresAt = payload.exp ? new Date(payload.exp * 1000).toLocaleString('zh-CN') : 'æœªçŸ¥';
                const issuedAt = payload.iat ? new Date(payload.iat * 1000).toLocaleString('zh-CN') : 'æœªçŸ¥';

                let html = '<div class="space-y-1">';
                html += `<div><strong>ç”¨æˆ· ID:</strong> ${payload.userId || payload.id || 'æœªçŸ¥'}</div>`;
                html += `<div><strong>ç­¾å‘æ—¶é—´:</strong> ${issuedAt}</div>`;
                html += `<div><strong>è¿‡æœŸæ—¶é—´:</strong> ${expiresAt}</div>`;
                html += `<div><strong>çŠ¶æ€:</strong> ${isExpired ? '<span class="text-red-600">âŒ å·²è¿‡æœŸ</span>' : '<span class="text-green-600">âœ… æœ‰æ•ˆ</span>'}</div>`;
                html += `<div class="mt-2"><strong>å®Œæ•´è½½è·:</strong><pre class="bg-gray-100 p-2 rounded mt-1">${JSON.stringify(payload, null, 2)}</pre></div>`;
                html += '</div>';

                decodeDiv.innerHTML = html;
            } catch (error) {
                decodeDiv.innerHTML = `<div class="text-red-600">âŒ è§£ç å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯• API è¿æ¥
        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            const token = localStorage.getItem('token');

            if (!token) {
                resultDiv.innerHTML = '<div class="text-red-600">âŒ æ²¡æœ‰ Tokenï¼Œæ— æ³•æµ‹è¯•</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="text-blue-600">â³ æ­£åœ¨æµ‹è¯•...</div>';

            try {
                // æµ‹è¯•ç›‘æ§åˆ—è¡¨ API
                const response = await fetch(`${API_BASE_URL}/api/monitor?action=list`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                let html = '<div class="space-y-2">';
                html += `<div><strong>HTTP çŠ¶æ€:</strong> ${response.status} ${response.statusText}</div>`;
                html += `<div><strong>å“åº”:</strong></div>`;
                html += `<pre class="bg-gray-100 p-2 rounded overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;
                html += '</div>';

                if (response.status === 401) {
                    html += '<div class="mt-4 p-4 bg-red-100 border border-red-400 rounded">';
                    html += '<strong>âŒ Token éªŒè¯å¤±è´¥</strong><br>';
                    html += 'å¯èƒ½çš„åŸå› ï¼š<br>';
                    html += '1. Token å·²è¿‡æœŸï¼ˆè¶…è¿‡ 7 å¤©ï¼‰<br>';
                    html += '2. JWT_SECRET ä¸åŒ¹é…<br>';
                    html += '3. Token æ ¼å¼é”™è¯¯<br>';
                    html += '<br><strong>å»ºè®®ï¼š</strong>ç‚¹å‡»ä¸‹æ–¹"æ¸…é™¤æ‰€æœ‰æ•°æ®"æŒ‰é’®ï¼Œç„¶åé‡æ–°ç™»å½•';
                    html += '</div>';
                } else if (response.status === 200) {
                    html += '<div class="mt-4 p-4 bg-green-100 border border-green-400 rounded">';
                    html += '<strong>âœ… API è¿æ¥æ­£å¸¸</strong><br>';
                    html += `ç›‘æ§æ•°é‡: ${data.data ? data.data.length : 0}`;
                    html += '</div>';
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="text-red-600">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ\n\næ¸…é™¤åéœ€è¦é‡æ–°ç™»å½•ã€‚')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('âœ… å·²æ¸…é™¤æ‰€æœ‰æ•°æ®');
                location.reload();
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = function() {
            displayStorageInfo();
            decodeToken();
        };
    </script>
</body>
</html>

